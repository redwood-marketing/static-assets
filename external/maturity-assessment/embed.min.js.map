{"version":3,"file":"embed.min.js","sources":["../../client/src/embed-loader.ts"],"sourcesContent":["/**\r\n * Redwood Assessment Embed Loader\r\n *\r\n * Lightweight script (~5KB) that creates and manages assessment iframes.\r\n * Usage:\r\n *\r\n * <script src=\"https://static.marketing.redwood.com/assessments/embed.min.js\"></script>\r\n * <script>\r\n *   RedwoodAssessment.push({\r\n *     type: 'maturity',\r\n *     element: document.getElementById('assessment-container'),\r\n *     onComplete: function(data) {\r\n *       window.location.href = '/thank-you/?session=' + data.sessionId;\r\n *     }\r\n *   });\r\n * </script>\r\n */\r\n\r\nimport type { CompletionData } from '@shared/types';\r\n\r\ninterface AssessmentConfig {\r\n  type: 'maturity';\r\n  element: HTMLElement | null;\r\n  version?: string;\r\n  onComplete?: (data: CompletionData) => void;\r\n  onReady?: () => void;\r\n  onResize?: (height: number) => void;\r\n  options?: {\r\n    sessionId?: string;\r\n    baseUrl?: string;\r\n  };\r\n}\r\n\r\ninterface PostMessageEvent {\r\n  type: string;\r\n  payload?: unknown;\r\n}\r\n\r\ntype QueueItem = AssessmentConfig | ((...args: unknown[]) => void);\r\n\r\n// Store active instances for cleanup\r\nconst instances = new Map<HTMLElement, HTMLIFrameElement>();\r\n\r\n// Default base URL - can be overridden in config\r\nconst DEFAULT_BASE_URL = (function() {\r\n  // Try to detect the script's origin by looking for our specific embed loader filename\r\n  const scripts = document.getElementsByTagName('script');\r\n  for (let i = scripts.length - 1; i >= 0; i--) {\r\n    const src = scripts[i].src;\r\n    if (!src) continue;\r\n\r\n    try {\r\n      const url = new URL(src);\r\n      const pathname = url.pathname;\r\n      // Only match the intended embed loader script filename\r\n      if (pathname.endsWith('/embed.min.js') || pathname.endsWith('/embed.js')) {\r\n        return url.origin + pathname.replace(/\\/embed(\\.min)?\\.js$/, '');\r\n      }\r\n    } catch {\r\n      // Ignore invalid URLs and continue searching\r\n      continue;\r\n    }\r\n  }\r\n  // Fallback to relative path (for local development)\r\n  return '';\r\n})();\r\n\r\nfunction createIframe(config: AssessmentConfig): HTMLIFrameElement | null {\r\n  const { element, type, version, options } = config;\r\n\r\n  if (!element) {\r\n    console.error('[RedwoodAssessment] No element provided');\r\n    return null;\r\n  }\r\n\r\n  // Clean up existing instance if any\r\n  const existing = instances.get(element);\r\n  if (existing) {\r\n    existing.remove();\r\n    instances.delete(element);\r\n  }\r\n\r\n  // Build iframe URL\r\n  const baseUrl = options?.baseUrl || DEFAULT_BASE_URL;\r\n  const versionPath = version ? `v${version}` : 'latest';\r\n  let iframeSrc = `${baseUrl}/${versionPath}/index-embed.html`;\r\n\r\n  // Add query params\r\n  const params = new URLSearchParams();\r\n  params.set('type', type);\r\n  params.set('embed', 'true');\r\n  if (options?.sessionId) {\r\n    params.set('session', options.sessionId);\r\n  }\r\n  iframeSrc += `?${params.toString()}`;\r\n\r\n  // Create iframe\r\n  const iframe = document.createElement('iframe');\r\n  iframe.src = iframeSrc;\r\n  iframe.style.cssText = `\r\n    width: 100%;\r\n    min-height: 600px;\r\n    border: none;\r\n    display: block;\r\n    overflow: hidden;\r\n  `;\r\n  iframe.setAttribute('allowfullscreen', 'true');\r\n  iframe.setAttribute('allow', 'clipboard-write');\r\n\r\n  // Store reference\r\n  instances.set(element, iframe);\r\n\r\n  // Clear container and append iframe\r\n  element.innerHTML = '';\r\n  element.appendChild(iframe);\r\n\r\n  return iframe;\r\n}\r\n\r\nfunction handleMessage(event: MessageEvent, config: AssessmentConfig, iframe: HTMLIFrameElement) {\r\n  // Validate message origin if we know the expected origin\r\n  const data = event.data as PostMessageEvent;\r\n\r\n  if (!data || typeof data.type !== 'string') {\r\n    return;\r\n  }\r\n\r\n  // Only handle our messages\r\n  if (!data.type.startsWith('redwood:assessment:')) {\r\n    return;\r\n  }\r\n\r\n  switch (data.type) {\r\n    case 'redwood:assessment:ready':\r\n      config.onReady?.();\r\n      break;\r\n\r\n    case 'redwood:assessment:complete':\r\n      config.onComplete?.(data.payload as CompletionData);\r\n      break;\r\n\r\n    case 'redwood:assessment:resize': {\r\n      const { height } = data.payload as { height: number };\r\n      if (height && height > 0) {\r\n        iframe.style.height = `${height}px`;\r\n        config.onResize?.(height);\r\n      }\r\n      break;\r\n    }\r\n\r\n    case 'redwood:assessment:navigate': {\r\n      // App navigated internally - could be used for analytics\r\n      break;\r\n    }\r\n  }\r\n}\r\n\r\nfunction initAssessment(config: AssessmentConfig): void {\r\n  // Wait for DOM if element not ready\r\n  if (!config.element) {\r\n    console.error('[RedwoodAssessment] Element not found');\r\n    return;\r\n  }\r\n\r\n  const iframe = createIframe(config);\r\n  if (!iframe) {\r\n    return;\r\n  }\r\n\r\n  // Set up message listener for this instance\r\n  const messageHandler = (event: MessageEvent) => {\r\n    // Only handle messages from our iframe\r\n    if (event.source !== iframe.contentWindow) {\r\n      return;\r\n    }\r\n    handleMessage(event, config, iframe);\r\n  };\r\n\r\n  window.addEventListener('message', messageHandler);\r\n\r\n  // Clean up listener if iframe is removed\r\n  const observer = new MutationObserver(() => {\r\n    if (!document.contains(iframe)) {\r\n      window.removeEventListener('message', messageHandler);\r\n      observer.disconnect();\r\n      if (config.element && instances.get(config.element) === iframe) {\r\n        instances.delete(config.element);\r\n      }\r\n    }\r\n  });\r\n  observer.observe(document.body, { childList: true, subtree: true });\r\n}\r\n\r\n// Process queue and set up API\r\nfunction processQueue(queue: QueueItem[]): void {\r\n  for (const item of queue) {\r\n    if (typeof item === 'function') {\r\n      item();\r\n    } else {\r\n      initAssessment(item);\r\n    }\r\n  }\r\n}\r\n\r\n// Initialize the global API\r\nfunction init(): void {\r\n  const existingQueue = (window as unknown as { RedwoodAssessment?: QueueItem[] }).RedwoodAssessment;\r\n\r\n  // Create the API object\r\n  const api = {\r\n    push(config: AssessmentConfig | ((...args: unknown[]) => void)): void {\r\n      if (typeof config === 'function') {\r\n        config();\r\n      } else {\r\n        // Wait for DOM ready if needed\r\n        if (document.readyState === 'loading') {\r\n          document.addEventListener('DOMContentLoaded', () => initAssessment(config));\r\n        } else {\r\n          initAssessment(config);\r\n        }\r\n      }\r\n    },\r\n\r\n    init(config: AssessmentConfig): void {\r\n      this.push(config);\r\n    },\r\n\r\n    destroy(element: HTMLElement): void {\r\n      const iframe = instances.get(element);\r\n      if (iframe) {\r\n        iframe.remove();\r\n        instances.delete(element);\r\n      }\r\n    },\r\n\r\n    version: '1.0.0'\r\n  };\r\n\r\n  // Replace the queue with the real API\r\n  (window as unknown as { RedwoodAssessment: typeof api }).RedwoodAssessment = api;\r\n\r\n  // Process any queued items\r\n  if (Array.isArray(existingQueue)) {\r\n    processQueue(existingQueue);\r\n  }\r\n}\r\n\r\n// Auto-initialize when script loads\r\nif (typeof window !== 'undefined') {\r\n  init();\r\n}\r\n\r\nexport { init, initAssessment };\r\nexport type { AssessmentConfig, CompletionData };\r\n"],"names":["instances","DEFAULT_BASE_URL","scripts","i","src","url","pathname","createIframe","config","element","type","version","options","existing","baseUrl","versionPath","iframeSrc","params","iframe","handleMessage","event","data","_a","_b","height","_c","initAssessment","messageHandler","observer","processQueue","queue","item","init","existingQueue","api"],"mappings":"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"}