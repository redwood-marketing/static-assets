{"version":3,"file":"embed.min.js","sources":["../../client/src/embed-loader.ts"],"sourcesContent":["interface EmbedCompletionData {\r\n  payload: unknown;\r\n  redirectUrl: string;\r\n}\r\n\r\ninterface EmbedConfig {\r\n  type: \"journal-exposure\";\r\n  element: HTMLElement | null;\r\n  version?: string;\r\n  onComplete?: (data: EmbedCompletionData) => void;\r\n  onReady?: () => void;\r\n  onResize?: (height: number) => void;\r\n  options?: {\r\n    baseUrl?: string;\r\n    reportBaseUrl?: string;\r\n    autoRedirect?: boolean;\r\n  };\r\n}\r\n\r\ninterface LoaderMessage {\r\n  type: string;\r\n  payload?: unknown;\r\n}\r\n\r\ntype QueueItem = EmbedConfig | ((...args: unknown[]) => void);\r\n\r\nconst instances = new Map<HTMLElement, HTMLIFrameElement>();\r\n\r\nconst DEFAULT_BASE_URL = (() => {\r\n  const scripts = document.getElementsByTagName(\"script\");\r\n  for (let i = scripts.length - 1; i >= 0; i -= 1) {\r\n    const src = scripts[i].src;\r\n    if (!src) continue;\r\n\r\n    try {\r\n      const url = new URL(src);\r\n      if (url.pathname.endsWith(\"/embed.min.js\") || url.pathname.endsWith(\"/embed.js\")) {\r\n        return url.origin + url.pathname.replace(/\\/embed(\\.min)?\\.js$/, \"\");\r\n      }\r\n    } catch {\r\n      continue;\r\n    }\r\n  }\r\n\r\n  return \"\";\r\n})();\r\n\r\nfunction createIframe(config: EmbedConfig): HTMLIFrameElement | null {\r\n  if (!config.element) {\r\n    console.error(\"[RedwoodJournalAssessment] Missing container element\");\r\n    return null;\r\n  }\r\n\r\n  const existing = instances.get(config.element);\r\n  if (existing) {\r\n    existing.remove();\r\n    instances.delete(config.element);\r\n  }\r\n\r\n  const baseUrl = config.options?.baseUrl || DEFAULT_BASE_URL;\r\n  const version = config.version || \"latest\";\r\n  const isDevVersion = version === \"dev\";\r\n  const versionPath = version && version !== \"latest\" && version !== \"dev\" ? `v${version}` : version;\r\n\r\n  const iframeUrl = new URL(\r\n    isDevVersion ? \"/\" : `${baseUrl}/${versionPath}/index-embed.html`,\r\n    isDevVersion ? window.location.origin : undefined\r\n  );\r\n\r\n  iframeUrl.searchParams.set(\"embed\", \"true\");\r\n  iframeUrl.searchParams.set(\"type\", config.type);\r\n  if (config.options?.reportBaseUrl) {\r\n    iframeUrl.searchParams.set(\"reportBaseUrl\", config.options.reportBaseUrl);\r\n  }\r\n\r\n  const iframe = document.createElement(\"iframe\");\r\n  iframe.src = iframeUrl.toString();\r\n  iframe.style.cssText = `\r\n    width: 100%;\r\n    min-height: 720px;\r\n    border: none;\r\n    display: block;\r\n    overflow: hidden;\r\n  `;\r\n  iframe.setAttribute(\"allowfullscreen\", \"true\");\r\n  iframe.setAttribute(\"allow\", \"clipboard-write\");\r\n\r\n  config.element.innerHTML = \"\";\r\n  config.element.appendChild(iframe);\r\n  instances.set(config.element, iframe);\r\n  return iframe;\r\n}\r\n\r\nfunction handleMessage(event: MessageEvent, config: EmbedConfig, iframe: HTMLIFrameElement) {\r\n  if (event.source !== iframe.contentWindow) {\r\n    return;\r\n  }\r\n\r\n  const data = event.data as LoaderMessage;\r\n  if (!data?.type || !data.type.startsWith(\"redwood:assessment:\")) {\r\n    return;\r\n  }\r\n\r\n  switch (data.type) {\r\n    case \"redwood:assessment:ready\":\r\n      config.onReady?.();\r\n      break;\r\n    case \"redwood:assessment:resize\": {\r\n      const payload = data.payload as { height?: number };\r\n      if (payload?.height && payload.height > 0) {\r\n        iframe.style.height = `${payload.height}px`;\r\n        config.onResize?.(payload.height);\r\n      }\r\n      break;\r\n    }\r\n    case \"redwood:assessment:complete\": {\r\n      const payload = data.payload as EmbedCompletionData;\r\n      config.onComplete?.(payload);\r\n\r\n      const autoRedirect = config.options?.autoRedirect ?? true;\r\n      if (autoRedirect && payload?.redirectUrl) {\r\n        window.location.href = payload.redirectUrl;\r\n      }\r\n      break;\r\n    }\r\n    default:\r\n      break;\r\n  }\r\n}\r\n\r\nfunction initAssessment(config: EmbedConfig): void {\r\n  const iframe = createIframe(config);\r\n  if (!iframe) {\r\n    return;\r\n  }\r\n\r\n  const messageHandler = (event: MessageEvent) => handleMessage(event, config, iframe);\r\n  window.addEventListener(\"message\", messageHandler);\r\n\r\n  const observer = new MutationObserver(() => {\r\n    if (!document.contains(iframe)) {\r\n      window.removeEventListener(\"message\", messageHandler);\r\n      observer.disconnect();\r\n      if (config.element && instances.get(config.element) === iframe) {\r\n        instances.delete(config.element);\r\n      }\r\n    }\r\n  });\r\n  observer.observe(document.body, { childList: true, subtree: true });\r\n}\r\n\r\nfunction processQueue(queue: QueueItem[]) {\r\n  queue.forEach((item) => {\r\n    if (typeof item === \"function\") {\r\n      item();\r\n    } else {\r\n      initAssessment(item);\r\n    }\r\n  });\r\n}\r\n\r\nfunction init() {\r\n  const globalWindow = window as unknown as {\r\n    RedwoodJournalAssessment?: QueueItem[];\r\n  };\r\n  const existingQueue = globalWindow.RedwoodJournalAssessment;\r\n\r\n  const api = {\r\n    push(config: QueueItem) {\r\n      if (typeof config === \"function\") {\r\n        config();\r\n      } else if (document.readyState === \"loading\") {\r\n        document.addEventListener(\"DOMContentLoaded\", () => initAssessment(config));\r\n      } else {\r\n        initAssessment(config);\r\n      }\r\n    },\r\n    init(config: EmbedConfig) {\r\n      this.push(config);\r\n    },\r\n    destroy(element: HTMLElement) {\r\n      const iframe = instances.get(element);\r\n      if (iframe) {\r\n        iframe.remove();\r\n        instances.delete(element);\r\n      }\r\n    },\r\n    version: \"1.0.0\"\r\n  };\r\n\r\n  (window as unknown as { RedwoodJournalAssessment: typeof api }).RedwoodJournalAssessment = api;\r\n\r\n  if (Array.isArray(existingQueue)) {\r\n    processQueue(existingQueue);\r\n  }\r\n}\r\n\r\nif (typeof window !== \"undefined\") {\r\n  init();\r\n}\r\n\r\nexport { init };\r\nexport type { EmbedConfig, EmbedCompletionData };\r\n"],"names":["instances","DEFAULT_BASE_URL","scripts","i","src","url","createIframe","config","existing","baseUrl","version","isDevVersion","versionPath","iframeUrl","iframe","handleMessage","event","data","payload","initAssessment","messageHandler","observer","processQueue","queue","item","init","existingQueue","api","element"],"mappings":"0BA0BA,MAAMA,MAAgB,IAEhBC,GAAoB,IAAM,CAC9B,MAAMC,EAAU,SAAS,qBAAqB,QAAQ,EACtD,QAASC,EAAID,EAAQ,OAAS,EAAGC,GAAK,EAAGA,GAAK,EAAG,CAC/C,MAAMC,EAAMF,EAAQC,CAAC,EAAE,IACvB,GAAKC,EAEL,GAAI,CACF,MAAMC,EAAM,IAAI,IAAID,CAAG,EACvB,GAAIC,EAAI,SAAS,SAAS,eAAe,GAAKA,EAAI,SAAS,SAAS,WAAW,EAC7E,OAAOA,EAAI,OAASA,EAAI,SAAS,QAAQ,uBAAwB,EAAE,CAEvE,MAAQ,CACN,QACF,CACF,CAEA,MAAO,EACT,GAAA,EAEA,SAASC,EAAaC,EAA+C,CACnE,GAAI,CAACA,EAAO,QACV,eAAQ,MAAM,sDAAsD,EAC7D,KAGT,MAAMC,EAAWR,EAAU,IAAIO,EAAO,OAAO,EACzCC,IACFA,EAAS,OAAA,EACTR,EAAU,OAAOO,EAAO,OAAO,GAGjC,MAAME,EAAUF,EAAO,SAAS,SAAWN,EACrCS,EAAUH,EAAO,SAAW,SAC5BI,EAAeD,IAAY,MAC3BE,EAAyBF,IAAY,UAAYA,IAAY,MAAQ,IAAIA,CAAO,GAAKA,EAErFG,EAAY,IAAI,IACpBF,EAAe,IAAM,GAAGF,CAAO,IAAIG,CAAW,oBAC9CD,EAAe,OAAO,SAAS,OAAS,MAAA,EAG1CE,EAAU,aAAa,IAAI,QAAS,MAAM,EAC1CA,EAAU,aAAa,IAAI,OAAQN,EAAO,IAAI,EAC1CA,EAAO,SAAS,eAClBM,EAAU,aAAa,IAAI,gBAAiBN,EAAO,QAAQ,aAAa,EAG1E,MAAMO,EAAS,SAAS,cAAc,QAAQ,EAC9C,OAAAA,EAAO,IAAMD,EAAU,SAAA,EACvBC,EAAO,MAAM,QAAU;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAOvBA,EAAO,aAAa,kBAAmB,MAAM,EAC7CA,EAAO,aAAa,QAAS,iBAAiB,EAE9CP,EAAO,QAAQ,UAAY,GAC3BA,EAAO,QAAQ,YAAYO,CAAM,EACjCd,EAAU,IAAIO,EAAO,QAASO,CAAM,EAC7BA,CACT,CAEA,SAASC,EAAcC,EAAqBT,EAAqBO,EAA2B,CAC1F,GAAIE,EAAM,SAAWF,EAAO,cAC1B,OAGF,MAAMG,EAAOD,EAAM,KACnB,GAAI,GAACC,GAAM,MAAQ,CAACA,EAAK,KAAK,WAAW,qBAAqB,GAI9D,OAAQA,EAAK,KAAA,CACX,IAAK,2BACHV,EAAO,UAAA,EACP,MACF,IAAK,4BAA6B,CAChC,MAAMW,EAAUD,EAAK,QACjBC,GAAS,QAAUA,EAAQ,OAAS,IACtCJ,EAAO,MAAM,OAAS,GAAGI,EAAQ,MAAM,KACvCX,EAAO,WAAWW,EAAQ,MAAM,GAElC,KACF,CACA,IAAK,8BAA+B,CAClC,MAAMA,EAAUD,EAAK,QACrBV,EAAO,aAAaW,CAAO,GAENX,EAAO,SAAS,cAAgB,KACjCW,GAAS,cAC3B,OAAO,SAAS,KAAOA,EAAQ,aAEjC,KACF,CAEE,CAEN,CAEA,SAASC,EAAeZ,EAA2B,CACjD,MAAMO,EAASR,EAAaC,CAAM,EAClC,GAAI,CAACO,EACH,OAGF,MAAMM,EAAkBJ,GAAwBD,EAAcC,EAAOT,EAAQO,CAAM,EACnF,OAAO,iBAAiB,UAAWM,CAAc,EAEjD,MAAMC,EAAW,IAAI,iBAAiB,IAAM,CACrC,SAAS,SAASP,CAAM,IAC3B,OAAO,oBAAoB,UAAWM,CAAc,EACpDC,EAAS,WAAA,EACLd,EAAO,SAAWP,EAAU,IAAIO,EAAO,OAAO,IAAMO,GACtDd,EAAU,OAAOO,EAAO,OAAO,EAGrC,CAAC,EACDc,EAAS,QAAQ,SAAS,KAAM,CAAE,UAAW,GAAM,QAAS,GAAM,CACpE,CAEA,SAASC,EAAaC,EAAoB,CACxCA,EAAM,QAASC,GAAS,CAClB,OAAOA,GAAS,WAClBA,EAAA,EAEAL,EAAeK,CAAI,CAEvB,CAAC,CACH,CAEA,SAASC,GAAO,CAId,MAAMC,EAHe,OAGc,yBAE7BC,EAAM,CACV,KAAKpB,EAAmB,CAClB,OAAOA,GAAW,WACpBA,EAAA,EACS,SAAS,aAAe,UACjC,SAAS,iBAAiB,mBAAoB,IAAMY,EAAeZ,CAAM,CAAC,EAE1EY,EAAeZ,CAAM,CAEzB,EACA,KAAKA,EAAqB,CACxB,KAAK,KAAKA,CAAM,CAClB,EACA,QAAQqB,EAAsB,CAC5B,MAAMd,EAASd,EAAU,IAAI4B,CAAO,EAChCd,IACFA,EAAO,OAAA,EACPd,EAAU,OAAO4B,CAAO,EAE5B,EACA,QAAS,OAAA,EAGV,OAA+D,yBAA2BD,EAEvF,MAAM,QAAQD,CAAa,GAC7BJ,EAAaI,CAAa,CAE9B,CAEI,OAAO,OAAW,KACpBD,EAAA"}